<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Path Finder</title>

    <link href="styles/PathFinderControler.css" rel="stylesheet" type="text/css" />
    <link href="styles/PathFinder.css" rel="stylesheet" type="text/css" />

    <script src="scripts/Standard.js" type="text/javascript"></script>
    <script src="scripts/PathFinderCaracol.js" type="text/javascript"></script>
    <script src="scripts/PathFinderControler.js" type="text/javascript"></script>
</head>
<body>
    <div class="controlerContainer">
        <div class="controler">
            <input type="button" value="play" onclick="play();" style="width:80px;height:22px;margin-left:10px;" />
            <input type="button" value="stop" onclick="stop();" style="width:80px;height:22px;margin-left:10px;margin-top:10px;" />    
            <label>Automatic <input type="checkbox"  id="chkAuto" checked="checked" /></label>
            <!--<input type="button" value="reset" onclick="reset();" style="width:80px;height:22px;margin-left:10px;margin-top:10px;" />-->

            <input type="file" id="uploadBtn" onchange="loadMap(this);" />
            <!--<textarea id="mapTxt"></textarea>-->
        </div>
    </div>
    <div id="mapsContainer"></div>

    <script type="text/javascript" language="javascript">

        //var pf;
        var intervalID;        
//        var MapInstance = new Map();
        //var mapMatrixMP = new MapMatrix({ MatrixSource: GeneratedMap, Events: { onError: function (e) { console.error(e); } } });
//            MapInstance.GenerateMap('51x37'); //51x37 //12x21//20x20//15x19//15x15//4x4//50x35
        //var controler;
        var screenRef = {
            mapsContainer: document.getElementById('mapsContainer'),
            mapTxt: document.getElementById('mapTxt'),
            pathFinders: [],
        };

//        function hola(){ 
//            return arguments.callee.toString().match(/^function\s(\w+)/)
//        }

        //window.onload = function ()
        //{
        //    pf = new PathFinderCaracol(mapMatrixMP, { Events: { onError: function (e) { console.error(e); }, onMoveComplete: moveComplete } });

         //   controler = new PathFinderControler(document.getElementById('mbContainer'), { Algorithm: pf, Events: { onError: function (e) { console.error(e); } }, MatrixSource: mapMatrixMP });
        //    controler.Redraw(GeneratedMap);
        //    //controler.Redraw({ MatrixVectorial: map});
        //}

        function moveComplete(controler, y, x){
            var result = controler.UpdatePosition(y, x);

            /*if (result == true) {
                setTimeout(
                    function() {
                        stop();

                        //alert('Congratulations!!');
                    },
                    100
                );
            }*/
        }

        function stop() {
            clearInterval(intervalID);
            intervalID = null;
            //controler.Stop();
        }

        function play()
        {
            /*if (!controler) {
                var mapCode = document.getElementById('mapTxt').value;

                var map = eval('(function () { return ' + mapCode + ';})()');

                var mapMatrixMP = new MapMatrix({ 
                    MatrixSource: map, 
                    Events: { 
                        onError: function (e) { console.error(e); } 
                    }, 
                });

                var pf = new PathFinderCaracol(
                    mapMatrixMP, 
                    { 
                        Events: { 
                            onError: function (e) { console.error(e); }, 
                            onMoveComplete: moveComplete,
                        }, 
                    }
                );

                controler = new PathFinderControler(
                    document.getElementById('mbContainer'), 
                    { 
                        Algorithm: pf, 
                        Events: { 
                            onError: function (e) { console.error(e); },
                        }, 
                        MatrixSource: mapMatrixMP,
                    }
                );
                controler.Redraw(map);
                //controler.Redraw({ MatrixVectorial: map});
            } */

            if (chkAuto.checked == true) 
            {
                for (var i = 0, len = screenRef.pathFinders.length; i < len; i++) {
                    screenRef.pathFinders[i].Play();
                }

                //controler.Play();

                intervalID = setTimeout(play, 100);
            }
            else
            {
                for (var i = 0, len = screenRef.pathFinders.length; i < len; i++) {
                    screenRef.pathFinders[i].Play();
                }

                //controler.Play();
            }
        }

        function reset() {
//            pf.Reset();
//            controler.Reset();
        };


        function loadMap (e) {
            try {
                var target = (e.target) ? e.target : event.srcElement;
                var reader = new FileReader();

                reader.onload = function () {
                    //screenRef.mapTxt.value = reader.result;

                    var mapCode = reader.result;

                    var mapContainer = document.createElement('div');
                    mapContainer.className = 'mbContainer';

                    screenRef.mapsContainer.appendChild(mapContainer);

                    var map = eval('(function () { return ' + mapCode + ';})()');

                    var mapMatrixMP = new MapMatrix({ 
                        MatrixSource: map, 
                        Events: { 
                            onError: function (e) { console.error(e); } 
                        }, 
                    });

                    var pf = new PathFinderCaracol(
                        mapMatrixMP, 
                        { 
                            Events: { 
                                onError: function (e) { console.error(e); }, 
                                onMoveComplete: function (y, x) { moveComplete(controler, y, x); },
                            }, 
                        }
                    );

                    var controler = new PathFinderControler(
                        mapContainer, 
                        { 
                            Algorithm: pf, 
                            Events: { 
                                onError: function (e) { console.error(e); },
                            }, 
                            MatrixSource: mapMatrixMP,
                        }
                    );
                    controler.Redraw(map);

                    screenRef.pathFinders.push(controler);

                    target.value = '';                    
                };

                reader.readAsText(target.files[0]);
            }
            catch (error) { console.error(error); }
        }

    </script>
</body>
</html>


